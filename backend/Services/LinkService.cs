using backend.Models;

namespace backend.Services;

public class LinkService
{
    private readonly UserService userService;

    public LinkService(UserService userService)
    {
        this.userService = userService;
    }

    public (Guid documentId, string version) Resolve(string shortname)
    {
        var coll = userService.Database.GetCollection<DocumentLink>();
        coll.EnsureIndex(x => x.ShortLink);
        DocumentLink? link = coll.Query()
            .Where(x => x.ShortLink == shortname)
            .FirstOrDefault();
        if (link is null) { 
            return (documentId: Guid.Empty, version: "");
        }

        var doc = userService.Database.GetCollection<Document>()
            .Query()
            .Where(x => x.Id == link.DocumentId)
            .FirstOrDefault();

        return (link.DocumentId, link.UseLatest ? doc.CurrentVersion : link.DocumentVersion!);
    }

    public string CreateLink(Guid documentId, bool useLatest)
    {
        var coll = userService.Database.GetCollection<DocumentLink>();
        coll.EnsureIndex(x => x.ShortLink);

        // Gerar um nome curto unico
        string shortLink;
        do
        {
            shortLink = GenerateShortLink();
        } while (coll.Exists(x => x.ShortLink == shortLink));

        var docCol = userService.Database.GetCollection<Document>();
        var doc = docCol.Query()
            .Where(x => x.Id == documentId)
            .FirstOrDefault();
        string version = doc?.CurrentVersion ?? string.Empty;

        DocumentLink link = new()
        {
            Id = Guid.NewGuid(),
            DocumentId = documentId,
            ShortLink = shortLink,
            UseLatest = useLatest,
            DocumentVersion = useLatest ? null : version
        };
        coll.Insert(link);
        return shortLink;
    }

    public void DeleteLinks(Guid documentId)
    {
        var coll = userService.Database.GetCollection<DocumentLink>();
        coll.EnsureIndex(x => x.DocumentId);
        coll.DeleteMany(x => x.DocumentId == documentId);
    }

    private static string GenerateShortLink()
    {
        int words = 3;
        Random random = new();
        string[] selectedWords = new string[words];
        for (int i = 0; i < words; i++)
        {
            int index = random.Next(0, wordCount);
            selectedWords[i] = wordList[index];
        }
        return string.Join("-", selectedWords);
    }

    private const int wordCount = 1592;
    private static readonly string[] wordList = [
        "babua",
        "badge",
        "bagne",
        "bahut",
        "bajan",
        "bakli",
        "balei",
        "balti",
        "banco",
        "banya",
        "barde",
        "barie",
        "basad",
        "basis",
        "basto",
        "batik",
        "baure",
        "beati",
        "becap",
        "bedim",
        "befan",
        "begem",
        "behav",
        "bekah",
        "belie",
        "beman",
        "benes",
        "bepaw",
        "berri",
        "besra",
        "bevel",
        "bezil",
        "bided",
        "bigha",
        "bilbi",
        "bimas",
        "biose",
        "birse",
        "bites",
        "bobet",
        "boder",
        "bogle",
        "boiko",
        "boldo",
        "bomos",
        "bonos",
        "boran",
        "boris",
        "botas",
        "bovid",
        "bowse",
        "bubas",
        "buffa",
        "bulge",
        "bunya",
        "burin",
        "buses",
        "butle",
        "caban",
        "cacam",
        "cader",
        "cadus",
        "cagit",
        "cajan",
        "calci",
        "callo",
        "camla",
        "caner",
        "canto",
        "capon",
        "carbo",
        "carya",
        "carom",
        "carve",
        "casse",
        "catur",
        "caved",
        "cavus",
        "cecil",
        "ceile",
        "cepes",
        "ceric",
        "cetin",
        "cinel",
        "cited",
        "coaid",
        "cocci",
        "coded",
        "cogon",
        "coyed",
        "colan",
        "colob",
        "combo",
        "compo",
        "conge",
        "conto",
        "copei",
        "coque",
        "cores",
        "corse",
        "coset",
        "cotta",
        "cover",
        "coxae",
        "cubas",
        "cueca",
        "culpa",
        "cunas",
        "cuppa",
        "cursa",
        "cutie",
        "dacus",
        "dayal",
        "dalar",
        "damia",
        "danio",
        "daren",
        "dated",
        "daven",
        "deair",
        "debug",
        "decke",
        "defis",
        "dekle",
        "della",
        "demot",
        "denom",
        "derat",
        "dessa",
        "deval",
        "dewar",
        "diced",
        "didos",
        "diked",
        "dimit",
        "dinka",
        "dipso",
        "disna",
        "diver",
        "dizen",
        "doggo",
        "doled",
        "domer",
        "donee",
        "donut",
        "doray",
        "dosed",
        "douma",
        "dowie",
        "duane",
        "dujan",
        "dunal",
        "dupes",
        "duret",
        "dutra",
        "facia",
        "fados",
        "faked",
        "famed",
        "fanti",
        "farer",
        "fates",
        "favor",
        "fecit",
        "felup",
        "ferie",
        "fetas",
        "feute",
        "fichu",
        "fifed",
        "filed",
        "finca",
        "firer",
        "focus",
        "fogou",
        "foray",
        "forma",
        "fovea",
        "fugal",
        "fumed",
        "funis",
        "fused",
        "fuzil",
        "gadus",
        "gaius",
        "galen",
        "gamba",
        "ganam",
        "ganza",
        "garle",
        "gater",
        "gavot",
        "gebur",
        "gemel",
        "genic",
        "genre",
        "gerip",
        "gibbi",
        "gigot",
        "ginep",
        "gisla",
        "goave",
        "gogos",
        "goloe",
        "gonid",
        "goral",
        "gorse",
        "gowan",
        "guato",
        "guiac",
        "guiro",
        "gunda",
        "guser",
        "habet",
        "hades",
        "hayey",
        "hajib",
        "haldu",
        "halos",
        "hamli",
        "hansa",
        "harem",
        "haste",
        "haute",
        "hazan",
        "hecte",
        "helge",
        "hemen",
        "hepar",
        "heros",
        "hexed",
        "hides",
        "hilsa",
        "hipmi",
        "hisis",
        "hodad",
        "hoker",
        "hollo",
        "hondo",
        "hoose",
        "horal",
        "hosel",
        "hoven",
        "hubba",
        "humid",
        "hutre",
        "yahan",
        "yameo",
        "yarke",
        "yerba",
        "yipes",
        "yojan",
        "yonis",
        "yucca",
        "yurok",
        "jades",
        "jakey",
        "jalur",
        "janua",
        "jasey",
        "javer",
        "jehup",
        "jerid",
        "jiber",
        "jirga",
        "joyce",
        "jonas",
        "josip",
        "jubes",
        "jugum",
        "julid",
        "jupes",
        "jutic",
        "kacha",
        "kahar",
        "kakar",
        "kalpa",
        "kanas",
        "kapai",
        "karen",
        "kaska",
        "kaver",
        "keeve",
        "kemal",
        "kerat",
        "keten",
        "kiaki",
        "kikoi",
        "kimmo",
        "kioko",
        "kiter",
        "koban",
        "koyan",
        "kokum",
        "kongu",
        "koran",
        "kosos",
        "kudzu",
        "kumis",
        "kusha",
        "labor",
        "lacto",
        "lagan",
        "layup",
        "lamas",
        "lamus",
        "langi",
        "lapsi",
        "larus",
        "lated",
        "latus",
        "laves",
        "leben",
        "leges",
        "lelia",
        "lenes",
        "leper",
        "lesiy",
        "levet",
        "liane",
        "licit",
        "lifen",
        "likes",
        "limbo",
        "limmu",
        "lines",
        "linne",
        "liras",
        "litra",
        "livre",
        "local",
        "lodur",
        "logos",
        "looed",
        "loran",
        "loser",
        "lotto",
        "lovee",
        "loxes",
        "lucid",
        "luket",
        "lunel",
        "lural",
        "luteo",
        "macaw",
        "madam",
        "magas",
        "mahar",
        "maybe",
        "mayor",
        "makes",
        "males",
        "mamas",
        "manba",
        "mange",
        "manna",
        "manul",
        "maras",
        "marie",
        "marse",
        "matar",
        "matka",
        "mauve",
        "mazel",
        "mecon",
        "meece",
        "melic",
        "menic",
        "mered",
        "merse",
        "mesua",
        "metic",
        "meuni",
        "miauw",
        "miked",
        "milia",
        "mimer",
        "mince",
        "minos",
        "mirex",
        "miter",
        "mixup",
        "model",
        "mohar",
        "moire",
        "molet",
        "momme",
        "moner",
        "moosa",
        "morae",
        "moric",
        "morus",
        "mosur",
        "motte",
        "mower",
        "mucin",
        "mugho",
        "mulla",
        "munic",
        "murmi",
        "mused",
        "muter",
        "nache",
        "naiad",
        "namaz",
        "nanda",
        "napoo",
        "nasab",
        "naval",
        "nawob",
        "neeze",
        "nenta",
        "netop",
        "newar",
        "nicol",
        "nific",
        "nilot",
        "niota",
        "nitos",
        "nixon",
        "nodes",
        "nokta",
        "nomos",
        "nopal",
        "nosey",
        "notum",
        "nowel",
        "nudie",
        "numud",
        "paced",
        "padre",
        "pagod",
        "payor",
        "pales",
        "palpi",
        "panes",
        "paola",
        "paque",
        "paren",
        "parma",
        "pasan",
        "paste",
        "patia",
        "paved",
        "pawer",
        "pedes",
        "peize",
        "pence",
        "pepla",
        "perit",
        "petit",
        "piaba",
        "picra",
        "pikey",
        "piled",
        "piman",
        "pinge",
        "pinup",
        "pipid",
        "pisco",
        "pivot",
        "podal",
        "poire",
        "polar",
        "polki",
        "pompa",
        "ponto",
        "pored",
        "porte",
        "posse",
        "poxed",
        "pudic",
        "puler",
        "punan",
        "pupae",
        "purga",
        "putti",
        "quake",
        "queal",
        "quina",
        "quoit",
        "rabot",
        "radix",
        "ragis",
        "raise",
        "rakes",
        "ramex",
        "ranid",
        "rarer",
        "ratel",
        "raupo",
        "raxes",
        "rebab",
        "rebid",
        "recco",
        "reded",
        "redue",
        "refit",
        "regle",
        "rejig",
        "relot",
        "remus",
        "renin",
        "repew",
        "rerub",
        "resin",
        "retax",
        "reuse",
        "rewet",
        "ricer",
        "rifle",
        "rimal",
        "ripal",
        "risqu",
        "river",
        "robur",
        "rohob",
        "roles",
        "rondo",
        "ropey",
        "roses",
        "rotor",
        "roved",
        "rowet",
        "rubus",
        "ruler",
        "runed",
        "rusma",
        "sabes",
        "sacae",
        "saeta",
        "sagos",
        "saiga",
        "sakha",
        "sales",
        "salpa",
        "samaj",
        "samoa",
        "sansi",
        "saqib",
        "saris",
        "sarum",
        "satin",
        "savey",
        "saxes",
        "secus",
        "segno",
        "sekar",
        "semen",
        "sengi",
        "seora",
        "seqed",
        "serer",
        "serra",
        "setae",
        "sewen",
        "sices",
        "sieur",
        "sikes",
        "simas",
        "singe",
        "sipid",
        "sirop",
        "sited",
        "siver",
        "sizes",
        "sodom",
        "sojas",
        "solen",
        "solus",
        "songo",
        "soree",
        "sosie",
        "sowel",
        "suber",
        "suede",
        "suyog",
        "sumak",
        "super",
        "surge",
        "sutta",
        "tabis",
        "taces",
        "tagua",
        "taipi",
        "taker",
        "talio",
        "tambo",
        "tanan",
        "tanti",
        "tapis",
        "tardo",
        "taroc",
        "tasco",
        "taube",
        "tawgi",
        "taxon",
        "teaze",
        "teiid",
        "telex",
        "tempe",
        "tenio",
        "tepal",
        "teres",
        "terzo",
        "tewer",
        "tical",
        "tigua",
        "tiler",
        "timid",
        "tinni",
        "tirma",
        "titis",
        "togae",
        "toise",
        "toles",
        "tondo",
        "tonus",
        "tophi",
        "toran",
        "torsi",
        "toter",
        "towel",
        "tubar",
        "tudor",
        "tulsi",
        "tunga",
        "turbo",
        "tutti",
        "vadis",
        "valet",
        "vance",
        "varda",
        "vates",
        "vejoz",
        "venie",
        "verey",
        "verus",
        "vexil",
        "vicua",
        "vijay",
        "vinca",
        "vinod",
        "virge",
        "visit",
        "vitro",
        "vivid",
        "voces",
        "voile",
        "volto",
        "vouli",
        "waded",
        "wages",
        "wakas",
        "wales",
        "wanna",
        "wasco",
        "wavey",
        "weber",
        "weren",
        "wifes",
        "wince",
        "wipes",
        "wisha",
        "wives",
        "woken",
        "woven",
        "xeric",
        "zayin",
        "zanze",
        "zemmi",
        "zigan",
        "zirak",
        "zoeas",
        "zoner",
        "zosma",

    ];


}
